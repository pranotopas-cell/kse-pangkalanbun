<script>
const supabaseClient = window.supabase.createClient(
 "https://secasrbeamduxqxwlspv.supabase.co",
 "sb_publishable_caJyFg1_Z89oUhtKg5XyoA_DfIgh6br"
);

// Cek session saat halaman dibuka
checkSession();

async function checkSession() {
  const { data } = await supabaseClient.auth.getSession();
  if (data.session) {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("appBox").style.display = "block";
    loadFiles();
  }
}

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { error } = await supabaseClient.auth.signInWithPassword({
    email,
    password
  });

  if (error) {
    alert("Login gagal: " + error.message);
  } else {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("appBox").style.display = "block";
    loadFiles();
  }
}

async function uploadFile() {
  const file = document.getElementById("fileInput").files[0];
  const type = document.getElementById("typeInput").value;

  const { data: userData } = await supabaseClient.auth.getUser();
  const user = userData.user;

  if (!file) return alert("Pilih file dulu");

  const filePath = `${user.email}/${file.name}`;

  const { error: uploadError } = await supabaseClient
    .storage
    .from("documents")
    .upload(filePath, file, { upsert: true });

  if (uploadError) return alert("Upload gagal: " + uploadError.message);

  const { data: publicURL } = supabaseClient
    .storage
    .from("documents")
    .getPublicUrl(filePath);

  await supabaseClient.from("documents").insert([
    {
      pt_email: user.email,
      type: type,
      file_name: file.name,
      file_url: publicURL.publicUrl
    }
  ]);

  alert("Upload berhasil");
  loadFiles();
}

async function loadFiles() {
  const { data: userData } = await supabaseClient.auth.getUser();
  const user = userData.user;

  const { data, error } = await supabaseClient
    .from("documents")
    .select("*")
    .eq("pt_email", user.email);

  if (error) return;

  let html = "";

  if (!data || data.length === 0) {
    html = "<p>Belum ada dokumen</p>";
  } else {
    data.forEach(file => {
      html += `
        <p>
          ${file.file_name} - ${file.type}
          <a href="${file.file_url}" target="_blank">Lihat</a>
        </p>
      `;
    });
  }

  document.getElementById("fileList").innerHTML = html;
}

async function logout() {
  await supabaseClient.auth.signOut();
  location.reload();
}
</script>
