<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSE_e-Documents</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #fcfdfe; scroll-behavior: smooth; }
        .kse-gradient { background: linear-gradient(135deg, #064e3b 0%, #065f46 100%); }
        .page, .section { display: none; }
        .active { display: block; }
        .flex-active { display: flex; }
        .btn-hover { transition: all 0.3s ease; }
        .btn-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .dropdown:hover .dropdown-menu { display: block !important; }
        .dropdown-menu { display: none; }
    </style>
</head>
<body class="text-slate-900">

    <main id="page-login" class="page min-h-screen items-center justify-center p-6 bg-[#f8fafc]">
        <div class="container mx-auto flex flex-col md:flex-row items-center gap-16">
            <div class="text-center space-y-6 flex-1">
                <img src="logo.png" class="w-64 mx-auto" alt="Logo KSE">
                <h1 class="text-5xl font-extrabold text-[#064e3b]">PT.KHATULISTIWA SINAR ENERGI</h1>
                <div class="space-y-1">
                    <p class="text-2xl font-semibold text-emerald-600">Sinergi Mengalirkan Energi</p>
                    <p class="italic text-gray-500 text-sm">"Energi Hebat, Mitra Sahabat, Harga Hemat"</p>
                </div>
                <div id="login-harga-display" class="pt-4 max-w-xl mx-auto">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 border-t border-slate-200 pt-6" id="login-harga-grid"></div>
                </div>
            </div>
            
            <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm border border-slate-100">
                <h2 class="font-bold text-slate-800 mb-6 text-center text-xl uppercase tracking-tight">Masuk Dashboard</h2>
                <div class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 outline-none focus:border-teal-500 font-semibold transition-all">
                    <input type="password" id="login-pass" placeholder="Password" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 outline-none focus:border-teal-500 font-semibold transition-all">
                    <button onclick="handleLogin()" class="w-full kse-gradient text-white py-4 rounded-xl font-bold uppercase tracking-widest btn-hover shadow-lg">Login</button>
                    <div class="text-center pt-2">
                        <button onclick="handleForgotPassword()" class="text-xs font-bold text-slate-400 hover:text-emerald-600 transition-colors uppercase tracking-widest">Lupa Password?</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <main id="page-dashboard" class="page flex-col min-h-screen">
        <nav class="kse-gradient text-white px-10 py-5 flex justify-between items-center sticky top-0 z-[100] shadow-xl">
            <div class="flex items-center gap-4 cursor-pointer" onclick="showSection('profile')">
                <img src="assets/logo-full.png" class="h-10 rounded bg-white p-1">
                <h1 class="text-xl font-bold tracking-tighter hidden md:block uppercase">PT.KHATULISTIWA SINAR ENERGI</h1>
            </div>
            
            <div class="flex items-center space-x-8">
                <div class="relative dropdown group">
                    <button class="text-xs font-bold uppercase tracking-widest opacity-80 hover:opacity-100 py-2">Company Profile ‚ñº</button>
                    <div class="dropdown-menu absolute right-0 md:left-0 w-56 bg-white border shadow-2xl rounded-2xl py-2 mt-2 z-[110] text-slate-700 font-semibold text-xs overflow-hidden">
                        <button onclick="showSection('profile')" class="block w-full text-left px-6 py-4 hover:bg-teal-50 border-b border-slate-50">Profil Perusahaan</button>
                        <button onclick="showSection('visi-misi')" class="block w-full text-left px-6 py-4 hover:bg-teal-50 border-b border-slate-50">Visi & Misi Kami</button>
                        <button onclick="showSection('legalitas')" class="block w-full text-left px-6 py-4 hover:bg-teal-50 border-b border-slate-50">Legalitas & Izin</button>
                        <button onclick="showSection('armada')" class="block w-full text-left px-6 py-4 hover:bg-teal-50 border-b border-slate-50">Data Armada </button>
                        <button onclick="showSection('kontak')" class="block w-full text-left px-6 py-4 hover:bg-teal-50">Hubungi Kami</button>
                    </div>
                </div>

                <div class="relative dropdown group text-teal-300">
                    <button class="text-xs font-bold uppercase tracking-widest py-2">E-Document ‚ñº</button>
                    <div class="dropdown-menu absolute right-0 w-56 bg-white border shadow-2xl rounded-2xl py-2 mt-2 z-[110] text-slate-700 font-semibold text-xs overflow-hidden">
                        <button onclick="loadDocuments('PURCHASE ORDER')" class="block w-full text-left px-6 py-4 hover:bg-teal-50 border-b border-slate-50">Purchase Order (PO)</button>
                        <button onclick="loadDocuments('SURAT JALAN')" class="block w-full text-left px-6 py-4 hover:bg-teal-50 border-b border-slate-50">Surat Jalan</button>
                        <button onclick="loadDocuments('INVOICE')" class="block w-full text-left px-6 py-4 hover:bg-teal-50 border-b border-slate-50">Invoice</button>
                        <button onclick="loadDocuments('FAKTUR PAJAK')" class="block w-full text-left px-6 py-4 hover:bg-teal-50 text-red-600 font-bold italic">Faktur Pajak</button>
                    </div>
                </div>
                
                <button onclick="showSection('harga')" class="text-xs font-bold uppercase tracking-widest opacity-80 hover:opacity-100">Publish Pertamina</button>
                
                <div class="flex flex-col items-end border-l border-white/20 pl-6 space-y-1">
                    <span id="display-user-email" class="text-[10px] font-bold text-emerald-300 tracking-tight lowercase truncate max-w-[150px]">user@email.com</span>
                    <button onclick="handleLogout()" class="bg-red-500 hover:bg-red-600 px-3 py-1.5 rounded-md text-[9px] font-black transition-all uppercase tracking-tighter">sign out</button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-6 md:px-10 py-10 flex-1">
            
            <div id="admin-panel" class="hidden mb-10 bg-white p-8 rounded-[2rem] border border-slate-200 shadow-sm">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-2 h-6 bg-teal-500 rounded-full"></div>
                    <h3 class="font-bold uppercase text-slate-800 tracking-tight text-sm">Upload Console</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">1. Pilih File</label>
                        <input type="file" id="file-input" class="w-full p-3 bg-slate-50 rounded-xl text-xs border border-slate-200">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">2. Kategori</label>
                        <select id="doc-category" class="w-full p-3 bg-slate-50 rounded-xl text-xs border border-slate-200 font-bold">
                            <option value="PURCHASE ORDER">PURCHASE ORDER</option>
                            <option value="SURAT JALAN">SURAT JALAN</option>
                            <option value="INVOICE">INVOICE</option>
                            <option value="FAKTUR PAJAK">FAKTUR PAJAK</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest italic">3. Client (Pilih Nama)</label>
                        <select id="select-penerima-auth" onchange="document.getElementById('manual-uid').value = this.value" class="w-full p-3 bg-teal-50 text-teal-700 rounded-xl font-bold text-xs border border-teal-100">
                            <option value="">-- Cari Nama Client --</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">4. Target UUID</label>
                        <input type="text" id="manual-uid" placeholder="UUID otomatis..." class="w-full p-3 bg-slate-50 rounded-xl text-xs border border-slate-200 outline-none focus:border-teal-500 font-bold">
                    </div>
                    <button onclick="startUploadProcess()" id="btn-upload" class="bg-[#064e3b] text-white p-4 rounded-xl font-bold text-xs uppercase btn-hover shadow-lg">Upload</button>
                </div>
            </div>

            <section id="section-profile" class="section active">
                <div class="kse-gradient p-12 md:p-20 rounded-[3rem] text-white shadow-2xl relative overflow-hidden">
                    <div class="relative z-10">
                        <h2 class="text-5xl font-black mb-8 tracking-tighter uppercase italic">Profil Perusahaan</h2>
                        <div class="grid md:grid-cols-2 gap-10 text-lg font-light opacity-95 leading-relaxed">
                            <div class="space-y-6">
                                <p><strong>PT Khatulistiwa Sinar Energi (KSE)</strong> adalah perusahaan distribusi energi yang berfokus pada penyediaan Bahan Bakar Minyak (BBM) Industri berkualitas tinggi. Kami berkomitmen mendukung roda ekonomi di wilayah <strong>Kalimantan Tengah</strong> dan sekitarnya melalui distribusi yang aman, transparan, dan tepat waktu.</p>
                                <p>Dengan pengalaman bertahun-tahun di sektor hilir migas, KSE telah menjadi mitra terpercaya bagi sektor pertambangan, perkebunan sawit, kontraktor jalan, hingga perkapalan di sepanjang aliran sungai dan daratan Kalimantan.</p>
                            </div>
                            <div class="space-y-6 bg-white/10 p-8 rounded-3xl backdrop-blur-sm border border-white/20">
                                <p>Kami mengoperasikan armada mandiri dengan standar keamanan tinggi untuk memastikan setiap liter energi yang kami kirimkan sampai ke lokasi klien dalam kondisi prima. Di PT KSE, kami percaya bahwa energi yang hebat harus dibarengi dengan pelayanan yang bersahabat dan harga yang kompetitif.</p>
                                <div class="pt-4 flex items-center gap-4">
                                    <div class="h-1 w-20 bg-emerald-400"></div>
                                    <span class="font-bold italic">Sinergi Mengalirkan Energi</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="section-visi-misi" class="section">
                <div class="grid md:grid-cols-2 gap-10">
                    <div class="bg-white p-12 rounded-[2.5rem] shadow-xl border-t-8 border-emerald-600">
                        <h2 class="text-sm font-black text-emerald-600 uppercase mb-6 tracking-widest italic">‚Äî Vision</h2>
                        <p class="text-3xl font-bold text-slate-800 italic leading-snug">"Menjadi Perusahaan Nasional terdepan dalam solusi distribusi energi yang mengintegrasikan teknologi, ketepatan waktu, dan integritas pelayanan untuk mendukung kemajuan industri Indonesia."</p>
                    </div>
                    <div class="bg-white p-12 rounded-[2.5rem] shadow-xl border-t-8 border-teal-600">
                        <h2 class="text-sm font-black text-teal-600 uppercase mb-6 tracking-widest italic">‚Äî Mission</h2>
                        <ul class="space-y-5 text-slate-600 font-medium">
                            <li class="flex items-start gap-3 italic">
                                <span class="bg-teal-100 text-teal-600 p-1 rounded-full text-[10px]">‚úì</span>
                                <span>Menjamin ketersediaan pasokan BBM industri secara berkelanjutan bagi seluruh mitra strategis.</span>
                            </li>
                            <li class="flex items-start gap-3 italic">
                                <span class="bg-teal-100 text-teal-600 p-1 rounded-full text-[10px]">‚úì</span>
                                <span>Mengoptimalkan rantai logistik untuk memastikan pengiriman yang presisi (Tepat Kualitas & Tepat Kuantitas).</span>
                            </li>
                            <li class="flex items-start gap-3 italic">
                                <span class="bg-teal-100 text-teal-600 p-1 rounded-full text-[10px]">‚úì</span>
                                <span>Menerapkan standar keselamatan kerja dan lindung lingkungan (HSSE) dalam setiap operasional.</span>
                            </li>
                            <li class="flex items-start gap-3 italic">
                                <span class="bg-teal-100 text-teal-600 p-1 rounded-full text-[10px]">‚úì</span>
                                <span>Membangun ekosistem bisnis yang transparan melalui digitalisasi dokumen (e-Documents).</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>

            <section id="section-legalitas" class="section">
                <div class="bg-white p-12 rounded-[3rem] shadow-xl max-w-4xl border-l-8 border-teal-600">
                    <h2 class="text-3xl font-bold text-[#064e3b] mb-8 uppercase italic border-b pb-4">Legalitas & Izin</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 italic font-bold text-xs uppercase">
                        <div class="p-4 bg-slate-50 rounded-2xl flex items-center gap-3"><span>üõ°Ô∏è</span> Akta Pendirian Perusahaan</div>
                        <div class="p-4 bg-slate-50 rounded-2xl flex items-center gap-3"><span>üõ°Ô∏è</span> NIB (Nomor Induk Berusaha)</div>
                        <div class="p-4 bg-slate-50 rounded-2xl flex items-center gap-3"><span>üõ°Ô∏è</span> Izin Niaga Umum / Mitra Penyalur</div>
                        <div class="p-4 bg-slate-50 rounded-2xl flex items-center gap-3"><span>üõ°Ô∏è</span> Sertifikasi Standar Mutu Dirjen Migas</div>
                        <div class="p-4 bg-slate-50 rounded-2xl flex items-center gap-3"><span>üõ°Ô∏è</span> NPWP & Pengukuhan PKP</div>
                        <div class="p-4 bg-slate-50 rounded-2xl flex items-center gap-3"><span>üõ°Ô∏è</span> Izin Transportasi Limbah/BBM</div>
                    </div>
                </div>
            </section>

            <section id="section-armada" class="section">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-8 rounded-[2.5rem] text-center shadow-lg border-b-8 border-teal-500">
                        <span class="text-xs font-bold text-slate-400 uppercase mb-4 block tracking-widest italic">Kapasitas Kecil</span>
                        <span class="block text-4xl font-black text-[#064e3b]">5.000 L</span>
                        <p class="text-[10px] mt-2 text-slate-400 font-bold uppercase italic tracking-tighter">Colt Diesel Double (CDD)</p>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] text-center shadow-lg border-b-8 border-teal-500">
                        <span class="text-xs font-bold text-slate-400 uppercase mb-4 block tracking-widest italic">Kapasitas Sedang</span>
                        <span class="block text-4xl font-black text-[#064e3b]">8.000 L</span>
                        <p class="text-[10px] mt-2 text-slate-400 font-bold uppercase italic tracking-tighter">Fuso / Tanker Medium</p>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] text-center shadow-lg border-b-8 border-teal-500">
                        <span class="text-xs font-bold text-slate-400 uppercase mb-4 block tracking-widest italic">Kapasitas Besar</span>
                        <span class="block text-4xl font-black text-[#064e3b]">10.000 - 20.000 L</span>
                        <p class="text-[10px] mt-2 text-slate-400 font-bold uppercase italic tracking-tighter">Tronton / Trailer</p>
                    </div>
                </div>
            </section>

            <section id="section-kontak" class="section">
                <div class="bg-white p-0 rounded-[3rem] shadow-2xl max-w-4xl mx-auto overflow-hidden border border-slate-100">
                    <div class="grid md:grid-cols-2">
                        <div class="p-12 kse-gradient text-white">
                            <h2 class="text-3xl font-black uppercase italic mb-8">Hubungi Kami</h2>
                            <div class="space-y-8">
                                <div class="flex items-start gap-4">
                                    <span class="text-2xl">üìç</span>
                                    <div>
                                        <p class="text-xs font-bold uppercase opacity-60 tracking-widest mb-1">Kantor Operasional</p>
                                        <p class="font-semibold">Jl. Trans Kalimantan, No. 168<br>Palangka Raya, Kalimantan Tengah</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-4">
                                    <span class="text-2xl">‚úâÔ∏è</span>
                                    <div>
                                        <p class="text-xs font-bold uppercase opacity-60 tracking-widest mb-1">Email Resmi</p>
                                        <p class="font-semibold">pt.khatulistiwa.sinar.energi@gmail.com</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-4">
                                    <span class="text-2xl">üìû</span>
                                    <div>
                                        <p class="text-xs font-bold uppercase opacity-60 tracking-widest mb-1">WhatsApp Hotline</p>
                                        <p class="font-semibold">0811-5884-1410</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-12 flex flex-col justify-center items-center text-center">
                            <img src="logo.png" class="w-32 mb-6 grayscale opacity-20">
                            <p class="text-slate-500 italic mb-8 italic">"Siap melayani kebutuhan energi industri di seluruh wilayah Kalimantan Tengah dengan profesionalisme tinggi."</p>
                            <a href="https://wa.me/6281158841410" target="_blank" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold uppercase tracking-widest btn-hover inline-block shadow-lg">Chat WhatsApp Sekarang</a>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="section-harga" class="section">
                <div id="harga-grid" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
            </section>

            <section id="section-documents" class="section">
                <div class="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border border-slate-100">
                    <div class="p-8 border-b bg-slate-50"><h3 id="doc-title" class="font-bold uppercase text-slate-800 italic text-sm tracking-widest">REPOSITORY</h3></div>
                    <table class="w-full text-left">
                        <tbody id="file-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <script>
        // CONFIGURATIONS
        const SB_URL = "https://yqdtgcjpfhiskywhowhu.supabase.co"; 
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxZHRnY2pwZmhpc2t5d2hvd2h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MDY0MTIsImV4cCI6MjA4NzA4MjQxMn0.Mlw3e8C4xKHcJPSMRkcsRXL5udtR9SeWk2GmqM1NyYc";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);
        
        const fbConfig = { projectId: "kse-harga-bbm-update", apiKey: "AIzaSyDenqfuE7Sjy773lp3k7WYh_3RRSr3nojM" };
        firebase.initializeApp(fbConfig);
        const dbF = firebase.firestore();

        let currentUser = null;
        let isAdmin = false;

        // AUTH CHECK
        async function checkAuth() {
            initHarga();
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                isAdmin = currentUser.email === "pt.khatulistiwa.sinar.energi@gmail.com";
                document.getElementById('display-user-email').innerText = currentUser.email;
                
                if(isAdmin) {
                    document.getElementById('admin-panel').classList.remove('hidden');
                    loadClientsFromSupabase(); 
                }
                document.getElementById('page-login').classList.remove('active', 'flex-active');
                document.getElementById('page-dashboard').classList.add('flex-active');
            } else {
                document.getElementById('page-login').classList.add('flex-active');
                document.getElementById('page-dashboard').classList.remove('active', 'flex-active');
            }
        }

        // LOAD CLIENTS
        async function loadClientsFromSupabase() {
            const { data, error } = await _supabase.from('profiles').select('id, email');
            const select = document.getElementById('select-penerima-auth');
            if(data) {
                select.innerHTML = '<option value="">-- Cari Nama Client --</option>';
                data.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.id; 
                    opt.textContent = item.email;
                    select.appendChild(opt);
                });
            }
        }

        // LOGIN HANDLER
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const { data, error } = await _supabase.auth.signInWithPassword({ email, password: pass });
            if (error) {
                alert("Login Gagal! Periksa Email/Password.");
            } else {
                await _supabase.from('profiles').upsert({ id: data.user.id, email: data.user.email });
                location.reload();
            }
        }

        // LOGOUT HANDLER (FIXED)
        async function handleLogout() {
            const { error } = await _supabase.auth.signOut();
            if (error) {
                console.error("Logout error:", error.message);
            }
            // Clear local storage/session just in case and reload
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = window.location.pathname; // Hard reload ke base URL
        }

        // FIREBASE PRICE UPDATER
        function initHarga() {
            dbF.collection("hargaBBM").doc("periode").onSnapshot(doc => {
                if(doc.exists) {
                    const data = doc.data().sekarang || {};
                    const wName = { 1: "JAMALI", 2: "KALIMANTAN", 3: "SULAWESI", 4: "PAPUA" };
                    [document.getElementById('harga-grid'), document.getElementById('login-harga-grid')].forEach(grid => {
                        if(grid) {
                            grid.innerHTML = "";
                            for(let i=1; i<=4; i++) {
                                const val = parseInt(data['wilayah'+i] || 0);
                                grid.innerHTML += `
                                    <div class="bg-white p-4 rounded-2xl border-b-4 border-emerald-500 text-center shadow shadow-emerald-100">
                                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">${wName[i]}</span>
                                        <h3 class="text-lg font-black text-[#064e3b]">Rp ${val.toLocaleString('id-ID')}</h3>
                                    </div>`;
                            }
                        }
                    });
                }
            });
        }

        // UPLOAD PROCESS
        async function startUploadProcess() {
            const fIn = document.getElementById('file-input');
            const uid = document.getElementById('manual-uid').value.trim();
            const sel = document.getElementById('select-penerima-auth');
            if(!fIn.files[0] || !uid) return alert("Lengkapi data!");
            
            const btn = document.getElementById('btn-upload');
            btn.innerText = "PROSES..."; btn.disabled = true;

            const file = fIn.files[0];
            const fileName = `${uid}/${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
            
            try {
                const { error: storageErr } = await _supabase.storage.from('kse-files').upload(fileName, file);
                if(storageErr) throw storageErr;

                const { data: urlData } = _supabase.storage.from('kse-files').getPublicUrl(fileName);
                let emailLabel = sel.selectedIndex > 0 ? sel.options[sel.selectedIndex].text : "Manual Client";

                const { error: dbErr } = await _supabase.from('documents').insert([{ 
                    name: file.name, url: urlData.publicUrl, 
                    type: document.getElementById('doc-category').value, 
                    user_id: uid, client_email: emailLabel
                }]);
                if(dbErr) throw dbErr;

                alert("Berhasil!"); location.reload();
            } catch (err) { 
                alert(err.message); 
                btn.innerText = "Upload"; 
                btn.disabled = false; 
            }
        }

        // DOCUMENT VIEW HANDLER
        async function loadDocuments(cat) {
            showSection('documents');
            document.getElementById('doc-title').innerText = cat;
            let q = _supabase.from('documents').select('*').eq('type', cat).order('created_at', { ascending: false });
            if(!isAdmin) q = q.eq('user_id', currentUser.id); 
            
            const { data } = await q;
            const tbody = document.getElementById('file-table-body');
            tbody.innerHTML = data?.length ? data.map(d => `
                <tr class="hover:bg-slate-50">
                    <td class="p-6">
                        <div class="font-bold text-slate-700 uppercase italic text-sm">${d.name}</div>
                        ${isAdmin ? `<div class="text-[9px] text-teal-600 font-bold uppercase mt-1">Client: ${d.client_email}</div>` : ''}
                    </td>
                    <td class="p-6 text-right space-x-2">
                        <button onclick="window.open('${d.url}', '_blank')" class="text-[10px] font-bold uppercase text-teal-600 border border-teal-200 px-4 py-2 rounded-lg">Preview</button>
                        ${isAdmin ? `<button onclick="deleteDoc('${d.id}')" class="bg-red-500 text-white px-4 py-2 rounded-lg text-[10px] font-bold uppercase">Hapus</button>` : `<a href="${d.url}" download class="bg-slate-900 text-white px-4 py-2 rounded-lg text-[10px] font-bold uppercase inline-block">Download</a>`}
                    </td>
                </tr>`).join('') : '<tr><td colspan="2" class="p-20 text-center text-slate-300 font-bold uppercase italic text-sm">Data Kosong</td></tr>';
        }

        // UTILITIES
        async function deleteDoc(id) { if(confirm("Hapus?")) { await _supabase.from('documents').delete().eq('id', id); location.reload(); } }
        function showSection(id) { document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById('section-' + id).classList.add('active'); window.scrollTo(0,0); }
        function handleForgotPassword() { const email = document.getElementById('login-email').value; if(!email) return alert("Isi email!"); _supabase.auth.resetPasswordForEmail(email); alert("Cek email!"); }

        window.onload = checkAuth;
    </script>
</body>
</html>
