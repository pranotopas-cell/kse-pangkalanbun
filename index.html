<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSE Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; }
        .kse-dark { background: #064e3b; }
        .page, .section { display: none; }
        .active { display: block; }
        .flex-active { display: flex; }
        .dropdown:hover .dropdown-menu { display: block; }
    </style>
</head>
<body>

    <main id="page-login" class="page flex-active min-h-screen items-center justify-center p-4 bg-white">
        <div class="w-full max-w-md p-8 border rounded-3xl shadow-lg">
            <h1 class="text-4xl font-black text-[#064e3b] italic italic mb-8 uppercase text-center">KSE PORTAL</h1>
            <input type="email" id="login-email" placeholder="Email" class="w-full p-4 bg-gray-100 rounded-xl mb-3 outline-none font-bold">
            <input type="password" id="login-pass" placeholder="Password" class="w-full p-4 bg-gray-100 rounded-xl mb-6 outline-none font-bold">
            <button onclick="handleLogin()" id="btn-login" class="w-full kse-dark text-white py-4 rounded-xl font-black uppercase shadow-lg">Masuk</button>
        </div>
    </main>

    <main id="page-dashboard" class="page flex-col min-h-screen">
        <nav class="kse-dark text-white p-5 flex justify-between items-center sticky top-0 z-50">
            <h1 class="text-xl font-black italic uppercase" onclick="showSection('profile')">PT KSE</h1>
            <div class="flex gap-4 text-[10px] font-black uppercase">
                <div class="relative dropdown">
                    <button>Tentang Kami ▼</button>
                    <div class="dropdown-menu absolute hidden left-0 w-40 bg-white text-black shadow-xl rounded-xl mt-2 overflow-hidden">
                        <button onclick="showSection('profile')" class="block w-full p-3 hover:bg-gray-100 border-b text-left">Profile</button>
                        <button onclick="showSection('visi-misi')" class="block w-full p-3 hover:bg-gray-100 border-b text-left">Visi Misi</button>
                        <button onclick="showSection('legalitas')" class="block w-full p-3 hover:bg-gray-100 border-b text-left">Legalitas</button>
                        <button onclick="showSection('armada')" class="block w-full p-3 hover:bg-gray-100 text-left">Armada</button>
                    </div>
                </div>
                <div class="relative dropdown text-teal-400">
                    <button>E-Doc ▼</button>
                    <div class="dropdown-menu absolute hidden right-0 w-40 bg-white text-black shadow-xl rounded-xl mt-2 overflow-hidden">
                        <button onclick="loadDocuments('PURCHASE ORDER')" class="block w-full p-3 hover:bg-gray-100 border-b text-left">PO</button>
                        <button onclick="loadDocuments('SURAT JALAN')" class="block w-full p-3 hover:bg-gray-100 border-b text-left">Surat Jalan</button>
                        <button onclick="loadDocuments('INVOICE')" class="block w-full p-3 hover:bg-gray-100 text-left">Invoice</button>
                    </div>
                </div>
                <button onclick="showSection('harga')">Harga</button>
                <button onclick="handleLogout()" class="text-red-400">Keluar</button>
            </div>
        </nav>

        <div class="p-6 max-w-5xl mx-auto w-full">
            <div id="admin-panel" class="hidden mb-8 bg-teal-50 p-6 rounded-3xl border-2 border-teal-200">
                <h3 class="font-black italic text-[#064e3b] mb-4 uppercase">Admin: Cepat Upload</h3>
                <div class="flex flex-wrap gap-3">
                    <input type="file" id="file-input" class="text-xs bg-white p-2 rounded-lg border flex-1">
                    <select id="doc-category" class="text-xs p-2 rounded-lg border">
                        <option value="PURCHASE ORDER">PO</option>
                        <option value="SURAT JALAN">SURAT JALAN</option>
                        <option value="INVOICE">INVOICE</option>
                    </select>
                    <button onclick="startUpload()" id="btn-upload" class="bg-teal-600 text-white px-6 py-2 rounded-lg text-xs font-black uppercase">Upload & Kirim</button>
                </div>
            </div>

            <section id="section-profile" class="section active">
                <div class="kse-dark p-10 rounded-[2rem] text-white shadow-xl">
                    <h2 class="text-3xl font-black italic uppercase mb-4">Profile</h2>
                    <p class="text-lg italic opacity-90">Distributor BBM Industri Resmi Kalimantan Tengah.</p>
                </div>
            </section>

            <section id="section-visi-misi" class="section">
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-white p-8 rounded-3xl shadow">
                        <h2 class="text-2xl font-black italic text-[#064e3b] uppercase mb-2">Visi</h2>
                        <p class="text-gray-600 font-bold italic">Menjadi pilar utama distribusi energi terpercaya.</p>
                    </div>
                    <div class="bg-white p-8 rounded-3xl shadow">
                        <h2 class="text-2xl font-black italic text-[#064e3b] uppercase mb-2">Misi</h2>
                        <p class="text-gray-600 font-bold italic">Layanan tepat waktu dan dokumen transparan.</p>
                    </div>
                </div>
            </section>

            <section id="section-legalitas" class="section">
                <div class="bg-white p-8 rounded-3xl shadow">
                    <h2 class="text-2xl font-black italic text-[#064e3b] uppercase mb-4">Legalitas</h2>
                    <p class="font-bold text-gray-700 italic">Izin Niaga Umum, Izin Transportasi, Sertifikat Metrologi.</p>
                </div>
            </section>

            <section id="section-armada" class="section">
                <div class="bg-white p-8 rounded-3xl shadow text-center">
                    <h2 class="text-2xl font-black italic text-[#064e3b] uppercase mb-4">Data Armada</h2>
                    <div class="flex justify-around font-black italic">
                        <div><p class="text-3xl">5K</p><p class="text-[10px] text-gray-400">LITER</p></div>
                        <div><p class="text-3xl">10K</p><p class="text-[10px] text-gray-400">LITER</p></div>
                    </div>
                </div>
            </section>

            <section id="section-harga" class="section">
                <div id="harga-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </section>

            <section id="section-documents" class="section">
                <div class="bg-white rounded-3xl shadow-xl overflow-hidden border">
                    <div class="p-4 kse-dark text-white font-black italic uppercase" id="doc-title">Arsip</div>
                    <div id="file-table-body" class="p-2 space-y-2"></div>
                </div>
            </section>
        </div>
    </main>

    <script>
        const SB_URL = "https://wrkmmeojhqpxchetaltl.supabase.co";
        const SB_KEY = "MASUKKAN_ANON_KEY_ABANG"; 
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        // Firebase Setup (Ringan)
        const firebaseConfig = { projectId: "kse-harga-bbm-update", apiKey: "AIzaSyDenqfuE7Sjy773lp3k7WYh_3RRSr3nojM" };
        firebase.initializeApp(firebaseConfig);
        const dbFirebase = firebase.firestore();

        let currentUser = null;
        let isAdmin = false;

        async function checkAuth() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                isAdmin = currentUser.email === "admin@kse.com"; // Sesuaikan
                if(isAdmin) document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('page-login').classList.remove('flex-active');
                document.getElementById('page-dashboard').classList.add('flex-active');
                initHarga();
                showSection('profile');
            } else {
                document.getElementById('page-login').classList.add('flex-active');
            }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const { error } = await _supabase.auth.signInWithPassword({ email, password: pass });
            if (error) alert(error.message); else location.reload();
        }

        async function startUpload() {
            const fileInput = document.getElementById('file-input');
            const cat = document.getElementById('doc-category').value;
            if(!fileInput.files[0]) return alert("File?");
            const email = prompt("Email Penerima:");
            if(!email) return;

            const file = fileInput.files[0];
            const name = `${Date.now()}_${file.name}`;
            await _supabase.storage.from('kse-files').upload(name, file);
            const { data: u } = _supabase.storage.from('kse-files').getPublicUrl(name);
            await _supabase.from('documents').insert([{ name: file.name, url: u.publicUrl, type: cat, user_id: email }]);
            alert("Sent!"); location.reload();
        }

        function initHarga() {
            dbFirebase.collection("hargaBBM").doc("periode").onSnapshot(doc => {
                const data = doc.data()?.sekarang || {};
                const grid = document.getElementById('harga-grid');
                grid.innerHTML = "";
                for(let i=1; i<=4; i++) {
                    grid.innerHTML += `<div class="bg-white p-6 rounded-3xl shadow border-2 border-teal-50 text-center">
                        <span class="text-[8px] font-black text-gray-400">W${i}</span>
                        <p class="text-xl font-black text-[#064e3b] italic">Rp ${(data['wilayah'+i]||0).toLocaleString('id-ID')}</p>
                    </div>`;
                }
            });
        }

        async function loadDocuments(cat) {
            showSection('documents');
            document.getElementById('doc-title').innerText = cat;
            let q = _supabase.from('documents').select('*').eq('type', cat);
            if(!isAdmin) q = q.eq('user_id', currentUser.email);
            const { data } = await q;
            const box = document.getElementById('file-table-body');
            box.innerHTML = data?.length ? data.map(d => `
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border">
                    <span class="text-xs font-bold uppercase italic">${d.name}</span>
                    <div class="flex gap-2">
                        <button onclick="window.open('${d.url}')" class="bg-teal-100 text-teal-800 p-2 rounded-lg text-[8px] font-black">PREVIEW</button>
                        <a href="${d.url}" download class="bg-[#064e3b] text-white p-2 rounded-lg text-[8px] font-black">UNDUH</a>
                    </div>
                </div>
            `).join('') : '<p class="p-10 text-center text-xs opacity-50">KOSONG</p>';
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-' + id).classList.add('active');
        }

        async function handleLogout() { await _supabase.auth.signOut(); location.reload(); }
        window.onload = checkAuth;
    </script>
</body>
</html>
